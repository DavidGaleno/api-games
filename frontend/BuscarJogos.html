<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="BuscarJogos.css" />
    <link rel="stylesheet" href="common.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
    />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@200;300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link rel="icon" href="./images/favicon (1).png" type="image/x-icon" />
    <title>Busca Jogos</title>
  </head>
  <body>
    <header>
      <img
        class="logo"
        src="./images/White_Minimalist_Simple_Aesthetic_Name_Twitter_Header__2_-removebg-preview.png"
        alt="Logo"
      />
      <nav>
        <ul>
          <li class="home"><a href="./BuscarJogos.html">Buscar Jogos</a></li>
          <li class="maisInfo"><a href="Dashboard.html">Dash</a></li>
        </ul>
      </nav>
    </header>

    <main>
      <div class="divPrincipal">
        <div class="divPesquisa">
          <input
            class="inputJogos"
            type="text"
            id="input"
            placeholder="Busque o jogo que quiser!"
          />
          <button class="material-symbols-outlined">search</button>
        </div>
        <div class="progress-container">
          <div class="progress-bar" id="myBar"></div>
        </div>
        <div class="data">
          <h2>Informações do Jogo</h2>
          <div class="data-content">
          </div>
        </div>
      </div>
    </main>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const searchButton = document.querySelector(
          ".material-symbols-outlined"
        );
        const popup = document.querySelector(".popup");
        const closeButton = document.querySelector(".close-button");
        const dataContent = document.querySelector(".data-content");
        const inputField = document.getElementById("input");
        const progressBar = document.getElementById("myBar");
        const body = document.body;
        const progressContainer = document.querySelector(".progress-container");

        // Event listener para o botão de pesquisa
        searchButton.addEventListener("click", function () {
          performSearch();
        });

        // Event listener para o campo de entrada para lidar com a tecla Enter
        inputField.addEventListener("keypress", function (event) {
          // Verificar se a tecla pressionada é Enter (código 13)
          if (event.key === "Enter") {
            performSearch();
          }
        });

        // Função para realizar a pesquisa
        function performSearch() {
          const searchTerm = inputField.value.trim().toLowerCase();
          if (searchTerm.length === 0) {
            return (dataContent.innerHTML =
              "<h3>Preencha o campo de Busca</h3>");
          }

          dataContent.innerHTML = "";
          // Adicionar classe de carregamento ao corpo

          // Exibir a barra de progresso
          progressContainer.style.display = "block";

          // Obtenha o valor do campo de pesquisa

          // Iniciar a barra de progresso
          let width = 0;
          const interval = setInterval(async function () {
            if (width >= 100) {
              clearInterval(interval);

              //Pega os jogos que contêm os caracteres inseridos na busca
              const jogosArray = await fetch(
                `http://127.0.0.1:8000/games/name/${searchTerm}`,
                {
                  method: "GET",
                  mode: "cors",
                }
              )
                .then((res) => res.json())
                .then((data) => data);

              // Lógica para verificar se o jogo foi encontrado no array.
              const jogoSelecionado = jogosArray.filter((jogo) =>
                jogo.name.startsWith(searchTerm)
              );

              function capitalizeWords(str) {
                return str.split(' ').map(word => word.replace(/\b\w/, function (char) {
                  return char.toUpperCase();
                })).join(' ');
              }

              // Se o jogo foi encontrado, preencha as informações e exiba o pop-up
              if (jogoSelecionado.length > 0) {
                jogoSelecionado.map(async (jogo) => {
                  const jogoDOM = `
                  <div class="dados-jogo">
                    <p>
                      Nome do Jogo:
                      <span id="nomeJogo">${capitalizeWords(jogo.name)}</span>
                    </p>
                    <p>
                      Ano de lançamento:
                      <span id="dataLancamento">
                        ${new Date(jogo.release_date)
                          .getDay()
                          .toString()
                          .padStart(2, "0")}/${(
                    new Date(jogo.release_date).getMonth() + 1
                  )
                    .toString()
                    .padStart(2, "0")}/${new Date(
                    jogo.release_date
                  ).getFullYear()}
                      </span>
                    </p>
                    <p>
                      Franquia:
                      <span id="franquia">
                        ${await fetch(
                          `http://127.0.0.1:8000/franchises/${jogo.franchise}`
                        )
                          .then((res) => res.json())
                          .then((data) => capitalizeWords(data.name))}
                      </span>
                    </p>
                    <p>
                      Publicadora:
                      <span id="publicadora">
                        ${await fetch(
                          `http://127.0.0.1:8000/publishers/${jogo.publisher}`
                        )
                          .then((res) => res.json())
                          .then((data) => capitalizeWords(data.name))}
                      </span>
                    </p>
                    <p>
                      Desenvolvedora:
                      <span id="desenvolvedora">
                        ${await fetch(
                          `http://127.0.0.1:8000/developers/${jogo.developer}`
                        )
                          .then((res) => res.json())
                          .then((data) => capitalizeWords(data.name))}
                      </span>
                    </p>
                    <p>
                      Engine:
                      <span id="engine">
                        ${await fetch(
                          `http://127.0.0.1:8000/game_engine/${jogo.gameEngine}`
                        )
                          .then((res) => res.json())
                          .then((data) => capitalizeWords(data.name))}
                      </span>
                    </p>
                  </div>
                `;
                  dataContent.innerHTML += jogoDOM;
                });
              } else {
                dataContent.innerHTML += "<h3> Jogo não Encontrado</h3>";
              }

              // Resetar a barra de progresso após a conclusão da pesquisa
              width = 0;
              progressBar.style.width = width + "%";

              // Ocultar a barra de progresso após a conclusão da pesquisa
              progressContainer.style.display = "none";
            } else {
              width++;
              progressBar.style.width = width + "%";
            }
          }, 10);
        }
      });
    </script>
  </body>
</html>
